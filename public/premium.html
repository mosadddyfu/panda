<!DOCTYPE html>
<html lang="ar" dir="rtl" id="htmlElement">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Buy Telegram Premium - Panda Store</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" type="image/png" href="/assets/pandastore.jpg">

  <!-- Shared site styles to match buy page navbar -->
  <link href="https://staropay.com/css/reset.css" rel="stylesheet" />
  <link href="https://staropay.com/css/base.css?v=2" rel="stylesheet" />
  <link href="https://staropay.com/css/nav.css" rel="stylesheet" />

  <!-- Axios Library -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- TonConnect Library -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <!-- SweetAlert2 Library -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="assets/alerts-theme.css" />
  <script defer src="assets/alerts-theme.js"></script>
  <!-- Font Awesome for gear icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- TonWeb Library for BOC encoding -->
  <script src="https://unpkg.com/@ton/ton@latest/dist/ton.min.js"></script>

  <style>
    /* رفع ملف عصري */
    .custom-file-input {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 260px;
    }

    .custom-file-input input[type="file"] {
      opacity: 0;
      width: 100%;
      height: 38px;
      position: absolute;
      left: 0;
      top: 0;
      cursor: pointer;
      z-index: 2;
    }

    .custom-file-label {
      display: block;
      background: #232f4b;
      color: #ffe082;
      border: 1.5px solid #2e3c5c;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 15px;
      font-weight: 600;
      text-align: right;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      width: 100%;
      min-width: 120px;
      z-index: 1;
    }

    .custom-file-input input[type="file"]:focus+.custom-file-label,
    .custom-file-input input[type="file"]:hover+.custom-file-label {
      background: #2e3c5c;
      color: #fff;
    }

    .custom-file-input .file-chosen {
      color: #ffe082;
      font-size: 14px;
      margin-right: 10px;
      vertical-align: middle;
    }

    /* تفاصيل الدفع */
    .pay-details-box {
      background: #19233a;
      border-radius: 14px;
      box-shadow: 0 2px 12px #0002;
      padding: 18px 12px 10px 12px;
      margin: 18px auto 10px auto;
      max-width: 420px;
      color: #ffe082;
      font-size: 17px;
      text-align: right;
      border: 1.5px solid #2e3c5c;
    }

    .pay-details-box label {
      color: #fff;
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }

    .pay-details-box input[type="file"] {
      background: #232f4b;
      border-radius: 8px;
      color: #ffe082;
      border: 1px solid #2e3c5c;
      padding: 6px 8px;
      margin-top: 6px;
      width: 100%;
    }

    /* زر النسخ */
    .copy-btn {
      background: linear-gradient(90deg, #ffd76a 60%, #ffe082 100%);
      color: #222;
      border: none;
      border-radius: 7px;
      font-size: 14px;
      font-weight: 700;
      padding: 3px 16px 3px 16px;
      margin-right: 7px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      box-shadow: 0 1px 4px #0001;
    }

    .copy-btn:hover {
      background: #ffe082;
      color: #000;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #1e2a47 0%, #0e1830 100%);
      color: #e6f2ff;
      font-size: 16px;
      margin: 0;
      padding: 0 12px 40px;
      text-align: center;
    }

    .header {
      background: rgba(10, 19, 38, 0.7);
      backdrop-filter: blur(8px);
      color: #e6f2ff;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(0, 163, 255, 0.15);
    }

    .nav {
      display: flex;
      gap: 10px;
    }

    .nav a {
      background: #0f1e36;
      color: #e6f2ff;
      text-decoration: none;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0, 163, 255, 0.18);
      transition: all .2s ease;
    }

    .nav a:hover {
      background: #0c1a2f;
      color: #fff;
    }

    .wallet-btn {
      font-size: 16px;
      padding: 6px 10px;
      border-radius: 8px;
      color: white;
      border: none;
    }

    .container {
      max-width: 900px;
      margin: 24px auto 0;
      padding: 16px 12px;
      background: transparent;
    }

    .section-title {
      font-size: 28px;
      margin: 12px 0 2px;
      color: #fff;
    }

    .section-sub {
      margin: 0 0 18px;
      color: #9ecbff;
    }

    label {
      display: block;
      margin: 0 0 8px;
      font-weight: 600;
      color: #cfe6ff;
      text-align: start;
    }

    input {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 18px;
      background: #0f1a2e;
      color: #e6f2ff;
      border: 1px solid rgba(0, 163, 255, 0.2);
      border-radius: 12px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    /* Smaller username textbox */
    #username {
      display: block;
      max-width: 360px;
      /* smaller width */
      padding: 12px 16px;
      /* match card horizontal padding */
      margin: 0 auto;
      /* center horizontally */
      font-size: 15px;
      border-radius: 18px;
      /* match card radius */
    }

    input:focus {
      border-color: #34b3ff;
      box-shadow: 0 0 0 3px rgba(0, 163, 255, 0.15);
    }

    .premium-options {
      display: grid;
      gap: 18px;
      grid-template-columns: 1fr;
      margin-top: 24px;
      padding-inline: 18px;
    }

    .premium-option {
      border-radius: 18px;
      padding: 18px 16px 16px;
      background: linear-gradient(180deg, rgba(13, 25, 48, 0.97), rgba(10, 22, 39, 0.97));
      color: #e6f2ff;
      text-align: center;
      border: 1.5px solid rgba(0, 163, 255, 0.18);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      opacity: 0;
      transform: translateY(18px);
      animation: fadeInUp .5s forwards;
      position: relative;
    }

    .premium-option:nth-child(1) {
      animation-delay: .05s
    }

    .premium-option:nth-child(2) {
      animation-delay: .1s
    }

    .premium-option:nth-child(3) {
      animation-delay: .15s
    }

    .premium-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 50px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 163, 255, 0.25);
      border-color: rgba(0, 163, 255, 0.35);
    }

    .premium-option.active {
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.6), 0 0 28px rgba(52, 179, 255, 0.45);
      border-color: rgba(52, 179, 255, 0.6);
      animation: glowPulse 1.2s ease-in-out infinite alternate;
    }

    @keyframes glowPulse {
      from {
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55), 0 0 16px rgba(52, 179, 255, 0.35);
      }

      to {
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.65), 0 0 32px rgba(52, 179, 255, 0.55);
      }
    }

    .plan-hero {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }

    .plan-hero img {
      width: 90px;
      height: 90px;
      object-fit: contain;
      filter: drop-shadow(0 8px 16px rgba(0, 163, 255, .2));
      background: transparent;
      border-radius: 0;
      border: none;
    }

    .premium-option h3 {
      margin: 4px 0 8px;
      font-size: 20px;
      color: #fff;
    }

    .premium-details {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 8px;
      margin: 6px 0 10px;
    }

    .premium-price {
      font-weight: 800;
      color: #ffd76a;
    }

    .ton-val {
      color: #9ecbff;
      font-size: 14px;
    }

    .benefits {
      list-style: none;
      padding: 0;
      margin: 8px 0 12px;
      color: #d7e9ff;
      text-align: start;
    }

    .benefits li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
    }

    .benefits li::before {
      content: "✓";
      color: #8be28b;
      font-weight: 900;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      justify-content: center;
    }

    .btn {
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
    }

    .btn-buy {
      background: linear-gradient(90deg, #ff4d77, #ff7a59);
    }

    .btn-buy:active {
      transform: translateY(1px);
    }

    /* Preview modal */
    .preview-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(3, 10, 20, 0.6);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
    }

    .preview-modal {
      width: min(560px, 92vw);
      border-radius: 18px;
      padding: 18px;
      background: linear-gradient(180deg, rgba(13, 25, 48, 0.97), rgba(10, 22, 39, 0.97));
      border: 1px solid rgba(0, 163, 255, .25);
      box-shadow: 0 24px 80px rgba(0, 0, 0, .55), 0 0 30px rgba(0, 163, 255, .25);
      transform: scale(.95);
      opacity: 0;
      transition: .18s ease;
      color: #e6f2ff;
    }

    .preview-backdrop.show {
      display: flex;
    }

    .preview-backdrop.show .preview-modal {
      transform: scale(1);
      opacity: 1;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .preview-title {
      font-size: 20px;
      font-weight: 800;
    }

    .preview-close {
      background: transparent;
      border: none;
      color: #cfe6ff;
      font-size: 22px;
      cursor: pointer;
    }

    .preview-body {
      text-align: center;
    }

    .preview-hero {
      display: flex;
      justify-content: center;
      margin: 6px 0 10px;
    }

    .preview-hero img {
      width: 110px;
      height: 110px;
      object-fit: contain;
    }

    .preview-price {
      font-weight: 800;
      color: #ffd76a;
      font-size: 18px;
      margin-top: 6px;
    }

    .preview-ton {
      color: #9ecbff;
      font-size: 14px;
    }

    .preview-benefits {
      list-style: none;
      padding: 0;
      margin: 10px 0 14px;
      text-align: start;
    }

    .preview-benefits li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }

    .preview-benefits li::before {
      content: "✓";
      color: #8be28b;
      font-weight: 900;
    }

    .preview-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 6px;
    }

    .btn-cancel {
      background: #0f1e36;
      border: 1px solid rgba(0, 163, 255, .3);
    }

    /* Settings */
    .wallet-container {
      display: flex;
      align-items: center;
    }

    .settings-container {
      display: flex;
      justify-content: flex-end;
      padding: 10px 20px;
      position: relative;
    }

    .settings-btn {
      background: #0f1e36;
      color: #e6f2ff;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(0, 163, 255, .2);
      transition: all .2s;
    }

    .settings-btn:hover {
      background: #0c1a2f;
    }

    .settings-menu {
      position: absolute;
      right: 0;
      top: 100%;
      background: #0f1a2e;
      color: #e6f2ff;
      font-size: 14px;
      border-radius: 12px;
      padding: 8px 0;
      text-align: center;
      display: none;
      min-width: 180px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, .4);
      z-index: 1000;
      border: 1px solid rgba(0, 163, 255, .2);
    }

    .settings-menu.show {
      display: block;
      animation: fadeInDropdown .2s ease;
    }

    .settings-menu-item {
      padding: 10px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .settings-menu-item:hover {
      background: #0c1a2f;
    }

    .settings-menu-item i {
      width: 20px;
      text-align: center;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInDropdown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #buy-btn {
      display: none;
    }

    @media (min-width: 720px) {
      .premium-options {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    /* Minimal helpers for buy-like mobile menu */
    .mobile-menu-container {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 80%;
      max-width: 300px;
      height: 100%;
      background-color: #030e17;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0, 0, 0, .5);
    }

    .mobile-menu-header {
      padding: 20px;
      display: flex;
      justify-content: flex-end;
    }

    .mobile-menu-body {
      padding: 20px;
    }

    .mobile-menu-ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .mobile-menu-li {
      margin-bottom: 15px;
    }

    .mobile-menu-a {
      color: #fff;
      text-decoration: none;
      font-size: 18px;
      display: block;
      padding: 10px;
      border-radius: 5px;
    }

    .mobile-menu-a:hover {
      background-color: #031724;
    }

    .mobile-wallet-btn {
      background: #031724;
      color: #fff;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 15px;
      font-size: 16px;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .burger-btn {
      display: none;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .navbar-wrapper {
        display: none;
      }

      .burger-btn {
        display: block;
      }
    }

    @media (min-width: 769px) {
      .burger-btn {
        display: none;
      }

      .mobile-menu-container {
        display: none !important;
      }
    }

    /* Force burger on the right, logo on the left on mobile */
    .navbar {
      direction: ltr !important;
      display: flex;
      align-items: center;
      position: relative;
    }

    .navbar .burger-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 0;
    }

    .navbar .logo-wrapper {
      margin-right: 0;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="logo-wrapper">
      <a class="navbar-brand" href="/index.html">
        <img alt="Panda Store" src="/assets/pandastore.jpg" />
        <h1>Panda Store</h1>
      </a>
    </div>
    <div class="navbar-wrapper">
      <div class="navbar-sub-wrapper">
        <ul class="navbar-items-wrapper">
          <li class="item-default"><a class="item item-a" href="/index.html" id="home-link">Home</a></li>
          <li class="item-default"><a class="item item-a" href="/buy.html" id="stars-link">Stars</a></li>
          <li class="item-default"><a class="item item-a" href="/premium.html" id="premium-link">Premium</a></li>
          <li class="item-default"><a class="item item-a" href="https://t.me/OMAR_M_SHEHATA" target="_blank"
              id="support-link">Support</a></li>
          <li class="item-default"><a class="item item-a" href="https://t.me/PandaStoreShop" target="_blank"
              id="channel-link">TG Channel</a></li>
        </ul>
      </div>
      <div class="navbar-sub-wrapper navbar-profiler" style="gap:8px">
        <button class="wallet-btn" style="background:#0f1e36;border:1px solid rgba(0,163,255,.25)"
          onclick="toggleLanguage()" id="language-switcher">AR / EN</button>
      </div>
    </div>
    <div class="burger-btn" id="burger_btn" aria-label="menu">
      <svg fill="none" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" width="28" height="28">
        <path d="M3 7C3 6.448 3.448 6 4 6H24C24.552 6 25 6.448 25 7C25 7.552 24.552 8 24 8H4C3.448 8 3 7.552 3 7Z"
          fill="#ffffff" />
        <path
          d="M3 14C3 13.448 3.448 13 4 13H24C24.552 13 25 13.448 25 14C25 14.552 24.552 15 24 15H4C3.448 15 3 14.552 3 14Z"
          fill="#ffffff" />
        <path
          d="M4 20C3.448 20 3 20.448 3 21C3 21.552 3.448 22 4 22H24C24.552 22 25 21.552 25 21C25 20.448 24.552 20 24 20H4Z"
          fill="#ffffff" />
      </svg>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div class="mobile-menu-container" id="mobile_menu_container">
    <div class="mobile-menu-header">
      <div class="mobile-menu-cross" id="mobile_menu_cross">
        <svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
          <path d="M19 5L5 19M5.00001 5L19 19" stroke="#ffffff" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </div>
    </div>
    <div class="mobile-menu-body">
      <div id="ton-connect-btn-mobile" class="mobile-wallet-btn">Connect Wallet : <br><br></div>
      <button class="mobile-wallet-btn" onclick="toggleLanguage()">AR / EN</button>
      <ul class="mobile-menu-ul">
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="/index.html" id="home-link-mobile">Home</a></li>
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="/buy.html" id="stars-link-mobile">Stars</a></li>
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="/premium.html" id="premium-link-mobile">Premium</a>
        </li>
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="https://t.me/OMAR_M_SHEHATA" target="_blank"
            id="support-link-mobile">Support</a></li>
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="https://t.me/PandaStoreShop" target="_blank"
            id="channel-link-mobile">TG Channel</a></li>
      </ul>
    </div>
  </div>

  <!-- Premium GIF Large Banner -->
  <div class="premium-gif-top">
    <img src="/assets/prem.gif" alt="Premium" />
  </div>
  <h1 class="section-title" id="main-title">اشترِ تليجرام بريميوم</h1><br>
  <p class="section-sub" id="sub-title">اشترك لنفسك أو لأصدقائك</p>
  <style>
    .premium-gif-top {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 12px auto;
      width: 100%;
      background: transparent;
      pointer-events: none;
    }

    .premium-gif-top img {
      height: 140px;
      width: auto;
      max-width: 90vw;
      border-radius: 0;
      background: transparent !important;
      box-shadow: none;
      display: block;
      margin: 0 auto;
      pointer-events: none;
    }

    @media (max-width: 600px) {
      .premium-gif-top img {
        height: 80px;
      }
    }
  </style>

  <!-- Premium GIF Banner -->

  <div class="container">
    <style>
      .premium-gif-banner {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 32px auto 0 auto;
        width: 100%;
        max-width: 400px;
        height: 120px;
        background: transparent;
        pointer-events: none;
      }

      .premium-gif-banner img {
        height: 110px;
        width: auto;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
        background: transparent;
        pointer-events: none;
        display: block;
        margin: 0 auto;
      }

      @media (max-width: 600px) {
        .premium-gif-banner {
          max-width: 220px;
          height: 70px;
          margin-top: 18px;
        }

        .premium-gif-banner img {
          height: 60px;
        }
      }
    </style>
    <label id="username-label">Telegram username</label>
    <input type="text" placeholder="@username" id="username" required /><br>
    <label id="plan-label">اختر خطة الاشتراك:</label>
    <div class="premium-options">
      <div class="premium-option">
        <div class="plan-hero"><img src="/assets/1month.png" alt="شهر واحد" /></div>
        <h3 id="plan-1-title">شهر واحد</h3>
        <div class="premium-details">
          <span id="plan-1-price" class="premium-price">$5.00</span>
          <span id="plan-1-ton" class="ton-val"></span>
        </div>
        <ul id="plan-1-features" class="benefits"></ul>
        <div class="actions">
          <button class="btn btn-buy" onclick="openPaymentModalWithPlan(1,5)">شراء الآن</button>
        </div>
      </div>
      <div class="premium-option">
        <div class="plan-hero"><img src="/assets/3month.png" alt="3 أشهر" /></div>
        <h3 id="plan-3-title">3 أشهر</h3>
        <div class="premium-details">
          <span id="plan-3-price" class="premium-price">$13.00</span>
          <span id="plan-3-ton" class="ton-val"></span>
        </div>
        <ul id="plan-3-features" class="benefits"></ul>
        <div class="actions">
          <button class="btn btn-buy" onclick="openPaymentModalWithPlan(3,13)">شراء الآن</button>
        </div>
      </div>
      <div class="premium-option">
        <div class="plan-hero"><img src="/assets/6month.png" alt="6 أشهر" /></div>
        <h3 id="plan-6-title">6 أشهر</h3>
        <div class="premium-details">
          <span id="plan-6-price" class="premium-price">$17.00</span>
          <span id="plan-6-ton" class="ton-val"></span>
        </div>
        <ul id="plan-6-features" class="benefits"></ul>
        <div class="actions">
          <button class="btn btn-buy" onclick="openPaymentModalWithPlan(6,17)">شراء الآن</button>
        </div>
      </div>
      <div class="premium-option">
        <div class="plan-hero"><img src="/assets/12month.png" alt="12 شهر" /></div>
        <h3 id="plan-12-title">12 شهر</h3>
        <div class="premium-details">
          <span id="plan-12-price" class="premium-price">$30.00</span>
          <span id="plan-12-ton" class="ton-val"></span>
        </div>
        <ul id="plan-12-features" class="benefits"></ul>
        <div class="actions">
          <button class="btn btn-buy" onclick="openPaymentModalWithPlan(12,30)">شراء الآن</button>
        </div>
      </div>
    </div>

    <button class="buy-btn" id="buy-btn" onclick="openPaymentModal()">اشترك الآن</button>
    <!-- نافذة اختيار طريقة الدفع -->
    <!-- نافذة دفع جديدة واضحة جداً -->
    <div id="payment-modal"
      style="display:none;position:fixed;z-index:3000;inset:0;background:rgba(10,20,40,0.85);backdrop-filter:blur(6px);align-items:center;justify-content:center;">
      <div
        style="background:#181f2e;border-radius:20px;max-width:370px;width:95vw;padding:28px 18px 22px 18px;box-shadow:0 8px 40px #000a,0 0 0 2px #ffd76a22;position:relative;">
        <button onclick="closePaymentModal()"
          style="position:absolute;top:12px;left:12px;background:none;border:none;font-size:28px;color:#ffd76a;font-weight:bold;cursor:pointer;">×</button>
        <h2 style="color:#ffd76a;text-align:center;font-size:22px;font-weight:900;margin-bottom:24px;">اختر طريقة الدفع
        </h2>
        <div style="display:flex;flex-direction:column;gap:18px;align-items:stretch;">
          <button onclick="payWithTON()"
            style="background:linear-gradient(90deg,#34b3ff,#0e1830);color:#fff;font-size:20px;font-weight:800;padding:16px 0;border-radius:14px;border:none;box-shadow:0 2px 12px #34b3ff44;display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;">
            <i class='fa-brands fa-telegram-plane' style='font-size:22px;'></i> الدفع عبر TON</button>
          <button onclick="showVodafoneCash()"
            style="background:linear-gradient(90deg,#e60000,#ff7a59);color:#fff;font-size:20px;font-weight:800;padding:16px 0;border-radius:14px;border:none;box-shadow:0 2px 12px #e6000044;display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;">
            <img src="assets/vodafone.png" alt="vodafone"
              style="width:24px;height:24px;vertical-align:middle;border-radius:50%;background:#fff;"> فودافون كاش
          </button>
          <button onclick="showInstaPay()"
            style="background:linear-gradient(90deg,#4a90e2,#0e1830);color:#fff;font-size:20px;font-weight:800;padding:16px 0;border-radius:14px;border:none;box-shadow:0 2px 12px #4a90e244;display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;">
            <img src="assets/instapay.png" alt="instapay"
              style="width:24px;height:24px;vertical-align:middle;border-radius:50%;background:#fff;"> InstaPay
          </button>
        </div>
        <div id="alt-pay-details" style="margin-top:28px;display:none;text-align:right;"></div>
      </div>
    </div>
    <script>
      // نافذة اختيار طريقة الدفع
      function openPaymentModal() {
        document.getElementById('payment-modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        document.getElementById('alt-pay-details').style.display = 'none';
        document.getElementById('alt-pay-details').innerHTML = '';
      }
      function closePaymentModal() {
        document.getElementById('payment-modal').style.display = 'none';
        document.body.style.overflow = '';
      }
      // TON
      function payWithTON() {
        document.getElementById('payment-modal').style.display = 'none';
        document.body.style.overflow = '';
        submitOrder();
      }
      // فودافون كاش
      function showVodafoneCash() {
        var usd = selectedPrice || 5;
        var egp = Math.round(usd * 50);
        var html = `<div class='pay-details-box'>
          <div style='margin-bottom:10px;font-size:16px;color:#ffd76a;'>المبلغ المطلوب: <b>${egp} جنيه</b></div>
          <div style='margin-bottom:10px;'>رقم فودافون كاش: <span id='vf-number' style='font-weight:700;font-size:17px;'>01099174529</span> <button onclick='copyText("01099174529")' class='copy-btn'>نسخ</button></div>
          <div style='margin-bottom:10px;'>ارفق صورة إثبات الدفع:<br><br><br>
            <span class="custom-file-input">
              <input type="file" id="vf-proof" accept="image/*" onchange="updateFileLabel(this, 'vf-file-label')" style="display:none;">
              <label class="custom-file-label" id="vf-file-label" for="vf-proof" style="display:block;cursor:pointer;">اختر ملف</label>
            </span>
            <span class="file-chosen" id="vf-file-chosen"></span>
          </div>
  <button class='btn btn-buy' style='width:100%;margin:14px auto 0 auto;font-size:14px;padding:6px 0;display:block;height:36px;line-height:18px;border-radius:10px;' onclick='submitAltPayment("vodafone")'>إرسال الطلب</button>
        </div>`;
        showAltPayDetails(html);
      }
      // انستا باي
      function showInstaPay() {
        var usd = selectedPrice || 5;
        var egp = Math.round(usd * 50);
        var html = `<div class='pay-details-box'>
          <div style='margin-bottom:10px;font-size:16px;color:#ffd76a;'>المبلغ المطلوب: <b>${egp} جنيه</b></div>
          <div style='margin-bottom:10px;'>يوزر InstaPay: <br><span id='insta-user' style='font-weight:700;font-size:17px;'>omarshehata_1@instapay</span>  <button onclick='copyText("omarshehata_1@instapay")' class='copy-btn'>نسخ</button></div>
          <div style='margin-bottom:10px;'>ارفق صورة إثبات الدفع:<br><br><br>
            <span class="custom-file-input">
              <input type="file" id="insta-proof" accept="image/*" onchange="updateFileLabel(this, 'insta-file-label')" style="display:none;">
              <label class="custom-file-label" id="insta-file-label" for="insta-proof" style="display:block;cursor:pointer;">اختر ملف</label>
            </span>
            <span class="file-chosen" id="insta-file-chosen"></span>
          </div>
  <button class='btn btn-buy' style='width:100%;margin:14px auto 0 auto;font-size:14px;padding:6px 0;display:block;height:36px;line-height:18px;border-radius:10px;' onclick='submitAltPayment("instapay")'>إرسال الطلب</button>
        </div>`;
        showAltPayDetails(html);
      }
      function showAltPayDetails(html) {
        var details = document.getElementById('alt-pay-details');
        details.innerHTML = html;
        details.style.display = 'block';
      }
      function copyText(txt) {
        navigator.clipboard.writeText(txt);
        Swal.fire({
          toast: true,
          position: 'top-end',
          iconHtml: '<span style="font-size:22px;color:#4bb543;">&#10003;</span>',
          title: '<span style="font-size:15px;font-weight:700;">تم النسخ</span>',
          showConfirmButton: false,
          timer: 1200,
          customClass: {
            popup: 'swal2-border-radius',
            title: 'swal2-title-custom',
            icon: 'swal2-icon-custom',
          }
        });
      }
      // تحديث اسم الملف المختار + معاينة الصورة
      function updateFileLabel(input, labelId) {
        var label = document.getElementById(labelId);
        var chosen = input.files && input.files.length > 0 ? input.files[0].name : 'لا يوجد ملف';
        label.textContent = input.files && input.files.length > 0 ? input.files[0].name : 'اختر ملف';
        // Show image preview if file is image
        var previewId = (labelId === 'vf-file-label') ? 'vf-file-chosen' : 'insta-file-chosen';
        var previewBox = document.getElementById(previewId);
        if (input.files && input.files[0] && input.files[0].type.startsWith('image/')) {
          var reader = new FileReader();
          reader.onload = function (e) {
            previewBox.innerHTML = `<img src="${e.target.result}" alt="preview" style="max-width:85px;max-height:85px;border-radius:12px;border:2.5px solid #ffd76a;margin-top:10px;box-shadow:0 2px 12px #ffd76a33;">`;
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          previewBox.innerHTML = '';
        }
      }
      // إرسال الطلب البديل (فودافون/انستا)
      async function submitAltPayment(method) {
        var username = document.getElementById("username").value.trim().replace(/^@/, '');
        if (!username) {
          Swal.fire({
            iconHtml: '<span style="font-size:32px;color:#e6b800;">&#33;</span>',
            title: '<span style="font-size:19px;font-weight:900;">أدخل اسم المستخدم</span>',
            html: '<div style="font-size:15px;color:#ffe6a0;">يرجى إدخال اسم المستخدم أولاً</div>',
            showConfirmButton: true,
            confirmButtonColor: '#34b3ff',
            customClass: {
              popup: 'swal2-border-radius',
              title: 'swal2-title-custom',
              icon: 'swal2-icon-custom',
              confirmButton: 'swal2-btn-custom',
            }
          });
          return;
        }
        var plan = selectedPlan;
        var price = selectedPrice;
        var egp = Math.round(price * 50);
        var fileInput = method === 'vodafone' ? document.getElementById('vf-proof') : document.getElementById('insta-proof');
        if (!fileInput.files[0]) {
          Swal.fire({
            iconHtml: '<span style="font-size:32px;color:#e6b800;">&#33;</span>',
            title: '<span style="font-size:19px;font-weight:900;">ارفق صورة</span>',
            html: '<div style="font-size:15px;color:#ffe6a0;">يرجى إرفاق صورة إثبات الدفع</div>',
            showConfirmButton: true,
            confirmButtonColor: '#34b3ff',
            customClass: {
              popup: 'swal2-border-radius',
              title: 'swal2-title-custom',
              icon: 'swal2-icon-custom',
              confirmButton: 'swal2-btn-custom',
            }
          });
          return;
        }
        // Close modal and show loading state immediately
        document.getElementById('payment-modal').style.display = 'none';
        document.body.style.overflow = '';
        Swal.fire({
          title: '<span style="font-size:19px;font-weight:900;">جاري معالجة الطلب ...</span>',
          html: '<div style="font-size:15px;color:#ffe6a0;">يرجى الانتظار حتى يتم إرسال الطلب</div>',
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => { Swal.showLoading(); },
          customClass: {
            popup: 'swal2-border-radius',
            title: 'swal2-title-custom',
            icon: 'swal2-icon-custom',
            confirmButton: 'swal2-btn-custom',
          }
        });
        var formData = new FormData();
        formData.append('username', username);
        formData.append('months', plan);
        formData.append('amountEgp', egp);
        formData.append('method', method);
        formData.append('proof', fileInput.files[0]);
        formData.append('refNumber', 'PS' + Math.random().toString(36).substring(2, 9).toUpperCase());
        try {
          await axios.post('https://panda-scz8.onrender.com/premium-alt', formData, { headers: { 'Content-Type': 'multipart/form-data' } });
        } catch (e) {
          // حتى لو فشل الطلب، أظهر رسالة تم استلام الطلب
        }
        Swal.fire({
          iconHtml: '<span style="font-size:32px;color:#4bb543;">&#10003;</span>',
          title: '<span style="font-size:19px;font-weight:900;">تم استلام الطلب</span>',
          html: '<div style="font-size:15px;color:#b6ffb6;">سيتم مراجعة الطلب والتواصل معك خلال دقائق</div>',
          showConfirmButton: true,
          confirmButtonColor: '#34b3ff',
          customClass: {
            popup: 'swal2-border-radius',
            title: 'swal2-title-custom',
            icon: 'swal2-icon-custom',
            confirmButton: 'swal2-btn-custom',
          }
        });
      }
    </script>
    <style>
      /* SweetAlert2 تخصيص شكل التنبيه المحسن */
      .swal2-popup.swal2-border-radius {
        border-radius: 18px !important;
        box-shadow: 0 4px 32px #0003 !important;
        background: #181f2e !important;
        color: #ffe082 !important;
        border: 2px solid #ffd76a33 !important;
      }
      .swal2-title-custom {
        font-size: 22px !important;
        font-weight: 900 !important;
        margin-bottom: 8px !important;
        color: #ffd76a !important;
        text-shadow: none !important;
      }
      .swal2-btn-custom {
        font-size: 16px !important;
        font-weight: 700 !important;
        border-radius: 10px !important;
        padding: 8px 24px !important;
        background: linear-gradient(90deg, #34b3ff, #0e1830) !important;
        color: #fff !important;
        box-shadow: 0 2px 12px #34b3ff44 !important;
        border: none !important;
        margin-top: 12px !important;
      }
      .swal2-icon-custom {
        margin-bottom: 0 !important;
        box-shadow: none !important;
        background: none !important;
      }
      .swal2-popup .swal2-html-container {
        color: #ffe082 !important;
        font-size: 16px !important;
        font-weight: 500 !important;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
      }
      /* إزالة أي دائرة سوداء حول الأيقونة */
      .swal2-icon {
        box-shadow: none !important;
        background: none !important;
        border: none !important;
      }
    </style>

    <div class="preview-ton" id="preview_ton"></div>
    <div class="preview-price" id="preview_price"></div>
    <ul class="preview-benefits" id="preview_benefits"></ul>

  </div>
  </div>
  </div>

  <script>
    // Initialize TonConnect (mobile button only, like buy page)
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://pandastores.netlify.app/tonconnect-manifest.json',
      buttonRootId: 'ton-connect-btn-mobile'
    });

    const MERCHANT_ADDRESS = "UQAcDae1BvWVAD0TkhnGgDme4b7NH9Fz8JXce-78TW6ekmvN";
    let currentTonUsd = null;
    let selectedPlan = null;
    let selectedPrice = null;
    let isEnglish = false; // Default to Arabic

    // Complete translations
    const translations = {
      title: {
        ar: "اشترِ تليجرام بريميوم",
        en: "Buy Telegram Premium"
      },
      subtitle: {
        ar: "اشترك لنفسك أو لأصدقائك",
        en: "Subscribe for yourself or friends"
      },
      usernameLabel: {
        ar: "اسم المستخدم على تليجرام",
        en: "Telegram username"
      },
      usernamePlaceholder: {
        ar: "@username",
        en: "@username"
      },
      planLabel: {
        ar: "اختر خطة الاشتراك:",
        en: "Choose a subscription plan:"
      },
      plans: {
        ar: {
          "1": "شهر واحد",
          "3": "3 شهور",
          "6": "6 شهور",
          "12": "12 شهر"
        },
        en: {
          "1": "1 Month",
          "3": "3 Months",
          "6": "6 Months",
          "12": "12 Months"
        }
      },
      prices: {
        ar: {
          "1": "5 دولار",
          "3": "13 دولار",
          "6": "17 دولار",
          "12": "30 دولار"
        },
        en: {
          "1": "$5.00",
          "3": "$13.00",
          "6": "$17.00",
          "12": "$30.00"
        }
      },
      tonPrice: {
        ar: "≈ %ton% TON",
        en: "≈ %ton% TON"
      },
      subscribeNow: {
        ar: "اشترك الآن",
        en: "Subscribe Now"
      },
      home: {
        ar: "الرئيسية",
        en: "Home"
      },
      stars: {
        ar: "النجوم",
        en: "Stars"
      },
      premium: {
        ar: "بريميوم",
        en: "Premium"
      },
      switchLanguage: {
        ar: "English",
        en: "اللغة العربية"
      },
      settings: {
        ar: "الإعدادات",
        en: "Settings"
      },
      features: {
        ar: {
          "1": ["كل مميزات بريميوم لمدة شهر", "ملحوظة: الشحن يتم عن طريق الدخول لحسابك", "ثقة وأمان بدون فتح أى شات", "بمجرد الطلب سيتم التواصل معك"],
          "3": ["شارة Premium", "تحميل أسرع", "تحويل الصوت إلى نص", "حدود أعلى للقنوات"],
          "6": ["شارة Premium", "تحميل أسرع", "تحويل الصوت إلى نص", "صور بروفايل متحركة"],
          "12": ["جميع مميزات Premium", "مساحة تخزين أكبر", "ملصقات حصرية", "أولوية في الدعم"]
        },
        en: {
          "1": ["All Premium features for 1 month", "Note: Recharge is done by logging into your account", "Trust & security without opening any chats", "Once requested, we will contact you"],
          "3": ["Premium badge", "Faster downloads", "Voice to text", "Higher channel limits"],
          "6": ["Premium badge", "Faster downloads", "Voice to text", "Animated profile photos"],
          "12": ["All Premium features", "More storage", "Exclusive stickers", "Priority support"]
        }
      }
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
      // Burger/mobile menu wiring
      const burgerBtn = document.getElementById('burger_btn');
      const mobileMenu = document.getElementById('mobile_menu_container');
      const closeBtn = document.getElementById('mobile_menu_cross');
      if (burgerBtn && mobileMenu && closeBtn) {
        burgerBtn.addEventListener('click', function () {
          mobileMenu.style.display = 'block';
          document.body.style.overflow = 'hidden';
        });
        closeBtn.addEventListener('click', function () {
          mobileMenu.style.display = 'none';
          document.body.style.overflow = '';
        });
      }

      // Fetch TON price and update plan prices
      fetchTonPrice();
    });

    async function fetchTonPrice() {
      const isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
      try {
        const res = await axios.get("https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd", { timeout: 5000 });
        currentTonUsd = res.data["the-open-network"].usd;
      } catch (e) {
        console.warn("Failed to fetch TON price for preview", e && e.message);
        if (isLocal && !currentTonUsd) {
          currentTonUsd = 5.0; // local fallback USD price per TON
          if (window.notify) notify.toast(isEnglish ? 'Using fallback TON price (local).' : 'استخدام سعر TON افتراضي (محلي).', 'info');
        }
      }

      updatePlanPrices();
      // Initialize all text elements
      updateAllText();
    }

    async function checkWalletBalance(requiredTon) {
      try {
        const walletConnection = tonConnectUI.wallet;
        if (!walletConnection) {
          return {
            success: false,
            message: isEnglish ?
              'Please connect your wallet first 🛡️' :
              'يرجى ربط المحفظة أولاً 🛡️'
          };
        }

        const response = await axios.get(`https://toncenter.com/api/v2/getAddressBalance?address=${walletConnection.account.address}`);
        const availableBalance = parseFloat(response.data.result) / 1e9;

        if (availableBalance < requiredTon) {
          return {
            success: false,
            message: isEnglish ?
              `Your balance (${availableBalance.toFixed(2)} TON) is insufficient. You need ${requiredTon.toFixed(2)} TON.` :
              `رصيدك (${availableBalance.toFixed(2)} TON) غير كافٍ. تحتاج ${requiredTon.toFixed(2)} TON.`
          };
        }

        return { success: true };
      } catch (error) {
        console.error('Balance check error:', error);
        return {
          success: false,
          message: isEnglish ?
            'Failed to check wallet balance. Please try again.' :
            'فشل التحقق من رصيد المحفظة. يرجى المحاولة مرة أخرى.'
        };
      }
    }

    async function encodeComment(comment) {
      try {
        // Create new cell
        const cell = new TonWeb.boc.Cell();

        // Write 32-bit zero (op=0 for simple comments)
        cell.bits.writeUint(0, 32);

        // Write comment as UTF-8
        cell.bits.writeString(comment);

        // Convert cell to BOC (Bag of Cells)
        const boc = await TonWeb.boc.Cell.toBoc(cell);

        // Convert BOC to base64
        return btoa(String.fromCharCode.apply(null, new Uint8Array(boc)));
      } catch (e) {
        console.error('Failed to encode comment:', e);
        return ''; // Return empty payload if encoding fails
      }
    }

    function updatePlanPrices() {
      if (!currentTonUsd) return;

      const plans = [1, 3, 6, 12];
      plans.forEach(plan => {
        const price = getPlanPrice(plan);
        const tonAmount = (price / currentTonUsd).toFixed(5);
        const element = document.getElementById(`plan-${plan}-ton`);
        if (element) {
          element.textContent = translations.tonPrice[isEnglish ? 'en' : 'ar'].replace('%ton%', tonAmount);
        }
      });
    }

    function getPlanPrice(months) {
      switch (months) {
        case 1: return 5;
        case 3: return 13;
        case 6: return 17;
        case 12: return 30;
        default: return 0;
      }
    }

    function toggleLanguage() {
      isEnglish = !isEnglish;
      const htmlElement = document.getElementById('htmlElement');
      const languageBtn = document.getElementById('language-switcher');

      // Change page direction and language
      htmlElement.dir = isEnglish ? 'ltr' : 'rtl';
      htmlElement.lang = isEnglish ? 'en' : 'ar';

      // Update all text elements
      updateAllText();
    }

    function updateAllText() {
      // Update language switcher text (if present)
      const langBtn = document.getElementById('language-switcher');
      if (langBtn) {
        if (langBtn.tagName.toLowerCase() === 'button') {
          langBtn.textContent = translations.switchLanguage[isEnglish ? 'en' : 'ar'];
        } else {
          const span = langBtn.querySelector('span');
          if (span) span.textContent = translations.switchLanguage[isEnglish ? 'en' : 'ar'];
        }
      }

      // Update main titles
      document.getElementById('main-title').textContent = translations.title[isEnglish ? 'en' : 'ar'];
      document.getElementById('sub-title').textContent = translations.subtitle[isEnglish ? 'en' : 'ar'];

      // Update form labels
      document.getElementById('username-label').textContent = translations.usernameLabel[isEnglish ? 'en' : 'ar'];
      document.getElementById('username').placeholder = translations.usernamePlaceholder[isEnglish ? 'en' : 'ar'];
      document.getElementById('plan-label').textContent = translations.planLabel[isEnglish ? 'en' : 'ar'];

      // Update buttons
      document.getElementById('buy-btn').textContent = translations.subscribeNow[isEnglish ? 'en' : 'ar'];

      // Update navigation links (desktop)
      document.getElementById('home-link').textContent = translations.home[isEnglish ? 'en' : 'ar'];
      document.getElementById('stars-link').textContent = translations.stars[isEnglish ? 'en' : 'ar'];
      document.getElementById('premium-link').textContent = translations.premium[isEnglish ? 'en' : 'ar'];
      // Update navigation links (mobile if present)
      const homeM = document.getElementById('home-link-mobile'); if (homeM) homeM.textContent = translations.home[isEnglish ? 'en' : 'ar'];
      const starsM = document.getElementById('stars-link-mobile'); if (starsM) starsM.textContent = translations.stars[isEnglish ? 'en' : 'ar'];
      const premiumM = document.getElementById('premium-link-mobile'); if (premiumM) premiumM.textContent = translations.premium[isEnglish ? 'en' : 'ar'];

      // Update plan titles and prices
      const plans = [1, 3, 6, 12];
      plans.forEach(plan => {
        const titleElement = document.getElementById(`plan-${plan}-title`);
        const priceElement = document.getElementById(`plan-${plan}-price`);
        if (titleElement) {
          titleElement.textContent = translations.plans[isEnglish ? 'en' : 'ar'][plan];
        }
        if (priceElement) {
          priceElement.textContent = translations.prices[isEnglish ? 'en' : 'ar'][plan];
        }
      });
      // Update features lists
      const feats = translations.features[isEnglish ? 'en' : 'ar'];
      [1, 3, 6, 12].forEach(m => {
        const ul = document.getElementById(`plan-${m}-features`);
        if (ul) {
          ul.innerHTML = '';
          feats[m].forEach(text => {
            const li = document.createElement('li');
            li.textContent = text;
            ul.appendChild(li);
          });
        }
      });
      // Update per-card buy buttons text
      document.querySelectorAll('.btn-buy').forEach(btn => {
        btn.textContent = isEnglish ? 'Buy Now' : 'شراء الآن';
      });
      // Update TON prices
      updatePlanPrices();
    }

    function selectPlan(months, price) {
      selectedPlan = months;
      selectedPrice = price;
      // Highlight selected plan visually
      const cards = document.querySelectorAll('.premium-option');
      cards.forEach(c => c.style.outline = 'none');
      const idx = { 1: 0, 3: 1, 6: 2, 12: 3 }[months];
      if (typeof idx !== 'undefined' && cards[idx]) {
        cards[idx].style.outline = '2.5px solid #34b3ff';
      }
    }

    function buyNow(months, price) {
      selectPlan(months, price);
      openPreview(months, price);
    }

    function openPreview(months, price) {
      const backdrop = document.getElementById('preview_backdrop');
      const title = document.getElementById('preview_title');
      const img = document.getElementById('preview_img');
      const ton = document.getElementById('preview_ton');
      const usd = document.getElementById('preview_price');
      const benefits = document.getElementById('preview_benefits');

      // Title
      title.textContent = isEnglish ? translations.plans.en[String(months)] : translations.plans.ar[String(months)];
      // Image
      const imgMap = { 1: '/assets/1month.png', 3: '/assets/3month.png', 6: '/assets/6month.png', 12: '/assets/12month.png' };
      img.src = imgMap[months] || '';
      img.alt = title.textContent;
      // Prices
      const priceText = isEnglish ? translations.prices.en[String(months)] : translations.prices.ar[String(months)];
      usd.textContent = priceText;
      if (currentTonUsd) {
        const tonAmount = (price / currentTonUsd).toFixed(5);
        ton.textContent = (isEnglish ? '≈ ' : '≈ ') + tonAmount + ' TON';
      } else {
        ton.textContent = '';
      }
      // Benefits
      const feats = translations.features[isEnglish ? 'en' : 'ar'][String(months)] || [];
      benefits.innerHTML = '';
      feats.forEach(t => { const li = document.createElement('li'); li.textContent = t; benefits.appendChild(li); });

      backdrop.classList.add('show');
      document.body.style.overflow = 'hidden';

      // Highlight active card
      const idx = { 1: 0, 3: 1, 6: 2, 12: 3 }[months];
      const cards = document.querySelectorAll('.premium-option');
      cards.forEach(c => c.classList.remove('active'));
      if (typeof idx !== 'undefined' && cards[idx]) cards[idx].classList.add('active');

      // Wire buttons
      const close = document.getElementById('preview_close');
      const cancel = document.getElementById('preview_cancel');
      const confirm = document.getElementById('preview_confirm');
      // Localize buttons
      cancel.textContent = isEnglish ? 'Cancel' : 'إلغاء';
      confirm.textContent = isEnglish ? 'Buy Now' : 'شراء الآن';
      const closeFn = () => { backdrop.classList.remove('show'); document.body.style.overflow = ''; cards.forEach(c => c.classList.remove('active')); };
      close.onclick = cancel.onclick = closeFn;
      confirm.onclick = () => { closeFn(); submitOrder(); };
    }

    async function submitOrder() {
      const username = document.getElementById("username").value.trim().replace(/^@/, '');

      if (!username) { notify.toast(isEnglish ? 'Enter Telegram username. ✏️' : 'أدخل اسم مستخدم تليجرام. ✏️', 'error'); return; }

      if (!selectedPlan) { notify.toast(isEnglish ? 'Please select a subscription plan. ✏️' : 'الرجاء اختيار خطة اشتراك. ✏️', 'error'); return; }

      const amountUSD = selectedPrice;

      let tonUsd = currentTonUsd;
      if (!tonUsd) {
        try {
          const r = await axios.get("https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd", { timeout: 5000 });
          tonUsd = r.data["the-open-network"].usd;
        } catch (e) {
          const isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
          if (isLocal) {
            tonUsd = 5.0; // local fallback
            notify.toast(isEnglish ? 'Using fallback TON price (local).' : 'استخدام سعر TON افتراضي (محلي).', 'info');
          } else {
            notify.toast(isEnglish ? 'Failed to get TON price, try later. 🌐' : 'لم يتم جلب سعر TON، حاول لاحقًا. 🌐', 'error');
            return;
          }
        }
      }

      const requiredTon = amountUSD / tonUsd;

      // Check wallet balance first
      const balanceCheck = await checkWalletBalance(requiredTon);
      if (!balanceCheck.success) { notify.toast(balanceCheck.message || (isEnglish ? 'Insufficient Balance 💰' : 'رصيد غير كافٍ 💰'), 'error'); return; }

      const tonAmountN = BigInt(Math.ceil(requiredTon * 1e9));
      const refNumber = 'PS' + Math.random().toString(36).substring(2, 9).toUpperCase();

      // Send without payload/comment to improve compatibility with wallets
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
          address: MERCHANT_ADDRESS,
          amount: tonAmountN.toString()
        }]
      };

      try {
        const connectedWallet = tonConnectUI.wallet;
        if (!connectedWallet) { notify.toast(isEnglish ? 'Connect your wallet first 🛡️' : 'اربط محفظتك أولاً 🛡️', 'warning'); return; }

        const result = await tonConnectUI.sendTransaction(tx);

        // Show persistent processing modal with localized text
        const processingTitle = isEnglish ? 'Processing your order ⏳' : 'جاري معالجة الطلب ⏳';
        const processingText = isEnglish ? 'Please do not leave the page until your order is completed.' : 'من فضلك لا تغادر الصفحة قبل إتمام طلبك.';
        notify.loading(processingTitle, processingText);

        setTimeout(async () => {
          try {
            await axios.post("https://panda-scz8.onrender.com/premium", {
              username,
              months: selectedPlan,
              amountTon: (requiredTon).toFixed(5),
              amountUsd: amountUSD.toFixed(2),
              refNumber: refNumber
            });
            notify.close();
            const msg = isEnglish ? `Premium for ${selectedPlan} months will be activated for @${username} within 5-10 minutes.` : `سيتم تفعيل بريميوم لمدة ${selectedPlan} أشهر لـ @${username} خلال 5-10 دقائق.`;
            notify.success(isEnglish ? 'Order received ✅' : 'تم استلام الطلب ✅', msg);
          } catch (err) {
            // Even if backend logging fails, inform success to user (as before)
            notify.close();
            const msg = isEnglish ? `Premium for ${selectedPlan} months will be activated for @${username} within 5-10 minutes.` : `سيتم تفعيل بريميوم لمدة ${selectedPlan} أشهر لـ @${username} خلال 5-10 دقائق.`;
            notify.success(isEnglish ? 'Order received ✅' : 'تم استلام الطلب ✅', msg);
          }
        }, 2000);

      } catch (error) {
        console.error('Transaction error:', error);

        let errorMessage = isEnglish ? 'Please try again.' : 'حاول مرة أخرى.';
        if (error.message.includes('Insufficient balance')) {
          errorMessage = isEnglish ?
            'Your wallet does not have enough TON to complete this transaction.' :
            'محفظتك لا تحتوي على رصيد كافٍ من TON لإتمام هذه العملية.';
        }

        notify.close();
        notify.toast(errorMessage || (isEnglish ? 'Transaction failed ❌' : 'فشلت المعاملة ❌'), 'error');
      }
    }

    // أضف دالة جديدة لفتح نافذة الدفع مع تحديد الخطة
    function openPaymentModalWithPlan(plan, price) {
      selectedPlan = plan;
      selectedPrice = price;
      openPaymentModal();
    }
  </script>
</body>

</html>
